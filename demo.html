<div style="display: flex; place-content: center; height: 5vh;     text-align: center;">

    <span>
        <span style="    font-weight: 600;
     font-size: larger;">NSDAI FaceRe </span> <br> Please focus on camera for Face Recognition.

    </span>
</div>

<div style="display: flex;justify-content: center;text-align: center;height: 90vh;">
    <div style="height: 80vh;overflow: hidden;border: 1px solid black;align-self: center;object-fit: cover;width: 40%;">
        <img src="https://i.stack.imgur.com/aFYTl.jpg?s=328&amp;g=1"
            style="width: 100%; height: 80%; object-fit: cover;">
        <div style="font-weight: 500; font-size:large; ">
            <h4>
                Name: <span class="h4" id="StudentName">Jonghun Kim</span>
                <br>
            </h4>
            <h4 class="h4">ID : <span class="h4" id="RollID">0082020C50123456</span></h4>
        </div>
    </div>
    <div style="width: 5%;"></div>

    <div style="width: 40%;-webkit-transform-origin-y: center;height: 80vh;place-self: center;border: 1px solid black;">
        <div style="position: relative; background-color: rgb(156, 198, 158);">
            <img id="FaceReFocusOverlay"
                src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBzdGFuZGFsb25lPSJubyI/Pgo8IURPQ1RZUEUgc3ZnIFBVQkxJQyAiLS8vVzNDLy9EVEQgU1ZHIDIwMDEwOTA0Ly9FTiIKICJodHRwOi8vd3d3LnczLm9yZy9UUi8yMDAxL1JFQy1TVkctMjAwMTA5MDQvRFREL3N2ZzEwLmR0ZCI+CjxzdmcgdmVyc2lvbj0iMS4wIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiB3aWR0aD0iNjAwLjAwMDAwMHB0IiBoZWlnaHQ9IjUwMC4wMDAwMDBwdCIgdmlld0JveD0iMCAwIDYwMC4wMDAwMDAgNTAwLjAwMDAwMCIKIHByZXNlcnZlQXNwZWN0UmF0aW89InhNaWRZTWlkIG1lZXQiPgo8bWV0YWRhdGE+CkNyZWF0ZWQgYnkgcG90cmFjZSAxLjE2LCB3cml0dGVuIGJ5IFBldGVyIFNlbGluZ2VyIDIwMDEtMjAxOQo8L21ldGFkYXRhPgo8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjAwMDAwMCw1MDAuMDAwMDAwKSBzY2FsZSgwLjEwMDAwMCwtMC4xMDAwMDApIgpmaWxsPSIjMDAwMDAwIiBzdHJva2U9Im5vbmUiPgo8cGF0aCBkPSJNMzIyIDQzMjcgbC0yIC0zODggNDMgMyA0MiAzIDMgMzQzIDIgMzQyIDI5NSAwIDI5NSAwIC0yIDQzIC0xIDQyCi00IC0zNyAtNCAtMzggLTI5MiAtMiAtMjkyIC0zIC0zIC0zNDIgLTIgLTM0MyAtMzUgMCAtMzUgMCAtMyAzODMgLTIgMzgyIC0zCi0zODh6Ii8+CjxwYXRoIGQ9Ik01MDEyIDQ2NzMgbC0yIC00MyAyOTUgMCAyOTUgMCAwIC0zNDUgMCAtMzQ1IDQ1IDAgNDUgMCAtMiAzODggLTMKMzg3IC0yIC0zODIgLTMgLTM4MyAtMzUgMCAtMzUgMCAtMiAzNDMgLTMgMzQyIC0yOTIgMyAtMjkyIDIgLTQgMzggLTQgMzcgLTEKLTQyeiIvPgo8cGF0aCBkPSJNMTUwMCAzNTI1IGMwIC0yMDggMSAtMjE1IDIwIC0yMTUgMTkgMCAyMCA3IDIwIDE5MCBsMCAxOTAgMTY4IDIKYzE2NSAzIDE2NyAzIDE3MCAyNiBsMyAyMiAtMTkwIDAgLTE5MSAwIDAgLTIxNXoiLz4KPHBhdGggZD0iTTQxMjAgMzcxNSBsMCAtMjUgMTcwIDAgMTcwIDAgMCAtMTkwIGMwIC0xODMgMSAtMTkwIDIwIC0xOTAgMTkgMAoyMCA3IDIwIDIxNSBsMCAyMTUgLTE5MCAwIC0xOTAgMCAwIC0yNXoiLz4KPHBhdGggZD0iTTI4NDMgMjkzMSBjLTE1MiAtNTUgLTI2OSAtMjAxIC0yOTIgLTM2NCAtMjcgLTE5MyA3MiAtMzg0IDI0NCAtNDY3Cjg5IC00MyAxMDUgLTQ2IDEwNSAtMjAgMCAxMSAtOCAyMyAtMTcgMjYgLTExMyAzNSAtMjA2IDExNiAtMjU2IDIyMSAtMzAgNjQKLTMyIDc1IC0zMiAxNzggMCAxMDQgMiAxMTQgMzMgMTc3IDUwIDEwMSAxMzIgMTc1IDI0NSAyMTcgMTcgNyAyNyAxOCAyNyAzMSAwCjExIC0xIDIwIC0yIDIwIC0yIC0xIC0yNiAtOSAtNTUgLTE5eiIvPgo8cGF0aCBkPSJNMzEwMCAyOTI5IGMwIC0xMiAxMCAtMjMgMjggLTMwIDExMSAtNDIgMTk0IC0xMTYgMjQ0IC0yMTcgMzEgLTYzCjMzIC03MiAzMyAtMTc3IDAgLTEwMyAtMiAtMTE0IC0zMiAtMTc4IC01MCAtMTA1IC0xNDMgLTE4NiAtMjU1IC0yMjEgLTEwIC0zCi0xOCAtMTUgLTE4IC0yNiAwIC0yNiAxNiAtMjMgMTA1IDIwIDIyMiAxMDcgMzExIDM3OSAyMDAgNjA2IC01MyAxMDggLTE2NAoyMDIgLTI3NSAyMzQgLTI2IDcgLTMwIDYgLTMwIC0xMXoiLz4KPHBhdGggZD0iTTE1MDAgMTQ4NSBsMCAtMjE1IDE5MCAwIGMxODMgMCAxOTAgMSAxOTAgMjAgMCAxOSAtOCAyMCAtMTY3IDIyCmwtMTY4IDMgLTMgMTkzIGMtMiAxODQgLTMgMTkyIC0yMiAxOTIgLTE5IDAgLTIwIC03IC0yMCAtMjE1eiIvPgo8cGF0aCBkPSJNNDQ1OCAxNTA4IGwtMyAtMTkzIC0xNjcgLTMgYy0xNjAgLTIgLTE2OCAtMyAtMTY4IC0yMiAwIC0xOSA3IC0yMAoxOTAgLTIwIGwxOTAgMCAwIDIxNSBjMCAyMDggLTEgMjE1IC0yMCAyMTUgLTE5IDAgLTIwIC04IC0yMiAtMTkyeiIvPgo8cGF0aCBkPSJNMzIwIDY4MSBsMCAtMzkxIDM0MCAwIDM0MCAwIDAgNDUgMCA0NSAtMjk1IDAgLTI5NSAwIC0yIDM0MyAtMyAzNDIKLTQyIDMgLTQzIDMgMCAtMzkweiBtODAgMzQgbDAgLTM0NSAyOTUgMCAyOTUgMCAwIC0zNSAwIC0zNSAtMzMwIDAgLTMzMCAwIDAKMzgwIDAgMzgwIDM1IDAgMzUgMCAwIC0zNDV6Ii8+CjxwYXRoIGQ9Ik01NjA3IDEwNjMgYy00IC0zIC03IC0xNTkgLTcgLTM0NSBsMCAtMzM4IC0yOTUgMCAtMjk1IDAgMCAtNDUgMAotNDUgMzQwIDAgMzQwIDAgMCAzOTAgMCAzOTAgLTM4IDAgYy0yMSAwIC00MiAtMyAtNDUgLTd6IG03MyAtMzgzIGwwIC0zODAKLTMzMCAwIC0zMzAgMCAwIDM1IDAgMzUgMjk1IDAgMjk1IDAgMCAzNDUgMCAzNDUgMzUgMCAzNSAwIDAgLTM4MHoiLz4KPC9nPgo8L3N2Zz4K"
                style="display: none; position: absolute; width: -webkit-fill-available; height: 100%;">

            <video class="input_video" style="width: 100%; place-self: center; object-fit: cover; height: 80%;"
                src=""></video>
        </div>

        <div style="font-weight: 500; font-size: large; width:100% ">
            <br>
            <button id="RetakeButton" style="width: 45%;    height: 4em; display: none;" onclick="retake()">üîÅ<br>
                Retake </button>
            <button id="SubmitButton" style="width: 45%;     height: 4em;display: none;"> ‚úîÔ∏è <br> Submit </button>
            <div style="    padding-top: .6em;">Match : <span class="font-weight: 500; font-size:large; "
                    id="matchPercentage"> Loading ... .
                </span>
                </h4>

            </div>
        </div>
    </div>

</div>



<script src="https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/dist/face-api.js"></script>

<script async>
    /**
     * Fetch Inject module.
     *
     * @module fetchInject
     * @license Zlib
     * @param {(USVString[]|Request[])} inputs Resources you wish to fetch.
     * @param {Promise} [promise] A promise to await before attempting injection.
     * @throws {Promise<ReferenceError>} Rejects with error when given no arguments.
     * @throws {Promise<TypeError>} Rejects with error on invalid arguments.
     * @throws {Promise<Error>} Whatever `fetch` decides to throw.
     * @throws {SyntaxError} Via DOM upon attempting to parse unexpected tokens.
     * @returns {Promise<Object[]>} A promise which resolves to an `Array` of
     *     Objects containing `Response` `Body` properties used by the module.
     */
    injectHead = function (i, n, j, e, c, t, s) {
        (t = n.createElement(j)), (s = n.getElementsByTagName(j)[0]);
        t.appendChild(n.createTextNode(e.text));
        t.onload = c(e);
        s ? s.parentNode.insertBefore(t, s) : n.head.appendChild(t);
    }; // eslint-disable-line
    fetchInject = function (inputs, promise) {
        if (!arguments.length) return Promise.reject(new ReferenceError("Failed to execute 'fetchInject': 1 argument required but only 0 present."));
        if (arguments[0] && arguments[0].constructor !== Array) return Promise.reject(new TypeError("Failed to execute 'fetchInject': argument 1 must be of type 'Array'."));
        if (arguments[1] && arguments[1].constructor !== Promise) return Promise.reject(new TypeError("Failed to execute 'fetchInject': argument 2 must be of type 'Promise'."));

        const resources = [];
        const deferreds = promise ? [].concat(promise) : [];
        const thenables = [];

        inputs.forEach((input) =>
            deferreds.push(
                window
                    .fetch(input)
                    .then((res) => {
                        return [res.clone().text(), res.blob()];
                    })
                    .then((promises) => {
                        return Promise.all(promises).then((resolved) => {
                            resources.push({ text: resolved[0], blob: resolved[1] });
                        });
                    })
            )
        );

        return Promise.all(deferreds).then(() => {
            resources.forEach((resource) => {
                thenables.push({
                    then: (resolve) => {
                        resource.blob.type.includes("text/css") ? injectHead(window, document, "style", resource, resolve) : injectHead(window, document, "script", resource, resolve);
                    },
                });
            });
            return Promise.all(thenables);
        });
    };

    // this is the Camera Input
    const videoElement = document.getElementsByClassName("input_video")[0];

    //
    loadLibraries = fetchInject([
        "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1631210127/camera_utils.js",
        "https://cdn.jsdelivr.net/npm/deepcopy@2.1.0/umd/deepcopy.min.js",
        "https://cdn.jsdelivr.net/npm/capture-video-frame@1.0.0/capture-video-frame.min.js",
        // "https://cdn.jsdelivr.net/npm/@mediapipe/control_utils@0.6/control_utils.js",
        // "https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3/drawing_utils.js",
        // "https://cdn.jsdelivr.net/npm/@mediapipe/face_detection@0.4/face_detection.js",
    ]);

    async function requestExternalImage(imageData) {
        const imageUrl = imageData[1];
        const res = await fetch(imageUrl);
        if (!(res.status < 400)) {
            console.error(res.status + " : " + (await res.text()));
            throw new Error("failed to fetch image from url: " + imageUrl);
        }

        let blob;
        try {
            blob = await res.blob();
            return await [imageData[0], imageData[1], await faceapi.bufferToImage(blob)];
        } catch (e) {
            console.error("received blob:", blob);
            console.error("error:", e);
            throw new Error("failed to load image from url: " + imageUrl);
        }
    }

    ImageUrls = {
        "self_1": "https://images.generated.photos/NQv6Dt_7n6IiEPue6OJro2q52quDwWrcfxLobYlT8Oc/rs:fit:512:512/wm:0.95:sowe:18:18:0.33/czM6Ly9pY29uczgu/Z3Bob3Rvcy1wcm9k/LnBob3Rvcy92M18w/NDY4Mjg0LmpwZw.jpg",
        "self_2": "https://images.generated.photos/OuQAZkglgbQufjOKgCF3RdTIXMr73RHACuHYXorW6JQ/rs:fit:512:512/wm:0.95:sowe:18:18:0.33/czM6Ly9pY29uczgu/Z3Bob3Rvcy1wcm9k/LnBob3Rvcy92M18w/NzA3MjY0LmpwZw.jpg",
        "self_3": "https://images.generated.photos/rEtZIf1Lx1awn9Y9ZZBTzqi2Kx-VMPQRtJx_jExvlzE/rs:fit:512:512/wm:0.95:sowe:18:18:0.33/czM6Ly9pY29uczgu/Z3Bob3Rvcy1wcm9k/LnBob3Rvcy92M18w/OTE4MTU5LmpwZw.jpg",
        "4": "https://images.generated.photos/W1-nFy63WDv1T1w64D7X92rMdeVec1n6gfXtqVsoZU0/rs:fit:512:512/wm:0.95:sowe:18:18:0.33/czM6Ly9pY29uczgu/Z3Bob3Rvcy1wcm9k/LnBob3Rvcy92M18w/Mzk5NDM1LmpwZw.jpg",
        "5": "https://i.ibb.co/vhV4KLm/Untitled.png",
        "6": "data:image/jpeg;base64,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",
        // "d": 'hsttps://images.generated.photos/W1-nFy63WDv1T1w64D7X92rMdeVec1n6gfXtqVsoZU0/rs:fit:512:512/wm:0.95:sowe:18:18:0.33/czM6Ly9pY29uczgu/Z3Bob3Rvcy1wcm9k/LnBob3Rvcy92M18w/Mzk5NDM1LmpwZw.jpg',
        // "g": 'https://images.generated.photos/W1-nFy63WDv1T1w64D7X92rMdeVec1n6gfXtqVsoZU0/rs:fit:512:512/wm:0.95:sowe:18:18:0.33/czM6Ly9pY29uczgu/Z3Bob3Rvcy1wcm9k/LnBob3Rvcy92ssM18w/Mzk5NDM1LmpwZw.jpg',
    };

    //collect descriptors of all in the list
    ImageDescriptors = null;
    FaceRecamera = null;
    GetImagedescriptor = Promise.allSettled([
        console.log("FaceRe Model loading. . "),
        faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights"),
        faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights"),
        faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights"),
        // faceapi.nets.faceExpressionNet.loadFromUri("/static/models"),
        faceapi.nets.ssdMobilenetv1.loadFromUri("https://cdn.jsdelivr.net/gh/justadudewhohacks/face-api.js@0.22.2/weights"),
    ])
        .then(() => {
            return Promise.all(
                Object.entries(ImageUrls).map(async (entry) => {
                    return await requestExternalImage(entry);
                })
            );
        })
        .then((ImagesBlobs) => {
            // console.log('Images Blobs: ', ImagesBlobs)
            // console.log('Images Blobs: ', ImagesBlobs.length)

            return Promise.all(
                ImagesBlobs.map(async (imageData) => {
                    const detections = await faceapi.detectSingleFace(imageData[2], new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
                    // console.log('detections: ', detections)
                    // debugger
                    return {
                        imageid: imageData[0],
                        imageUrl: imageData[1],
                        imageData: imageData[2],
                        detections: detections.descriptor,
                    };
                })
            );
        })
        .then((ImgeDescriptors) => {
            console.log("Image Descriptors: ", ImgeDescriptors);
            ImageDescriptors = ImgeDescriptors;
            return ImgeDescriptors;
        });

    lastUpdateTime = new Date().getTime();
    interval = 100;
    //when descriptor is ready and all dependecies are loaded
    Promise.allSettled([loadLibraries, GetImagedescriptor]).then(() => {
        //Get Camera and start
        FaceRecamera = new Camera(videoElement, {
            onFrame: async () => {
                if (((new Date().getTime()) - lastUpdateTime > interval)) {
                    result = await HandleNewFrame({ image: videoElement });
                    if (typeof result !== "undefined") HandleResults(result);
                    lastUpdateTime = new Date().getTime();
                }
                // alert('hi')

            },
            width: 1280,
            height: 720,
        });

        FaceRecamera.start();
    });

    detectionResults = null;
    async function HandleNewFrame(frame) {
        const detections = await faceapi.detectSingleFace(frame.image, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
        if (typeof detections !== "undefined") {
            distances = ImageDescriptors.map((each) => {
                each["distance"] = faceapi.euclideanDistance(each.detections, detections.descriptor);
                return each;
            });
            // console.log(distances);

            return distances;
        }
    }

    const framesToRecord = 10
    function HandleResults(results) {

        if (detectionResults === null) detectionResults = []

        // console.log("HandleResults: ", results, detectionResults.length);


        if (detectionResults.length < framesToRecord) {
            detectionResults.push(deepcopy(results))

            FaceReFocusOverlay = document.getElementById("FaceReFocusOverlay")
            FaceReFocusOverlay.style.display = 'block'

            setTimeout(function () {
                FaceReFocusOverlay.style.display = 'none'
            }, 1000);

            result = PrepareResults()

            if (detectionResults.length === framesToRecord) {
                console.log(framesToRecord, " frames recorded")
                //handle predictions
                FrameCollectionCompleted(result)
            }
        }

        else if (detectionResults.length === framesToRecord) {
            //
            // console.log("ignored")
        }

    }

    function PrepareResults() {

        result2d = detectionResults.map((each) => {
            return each.map((each2) => {
                return parseFloat(each2.distance)
            })
        })

        let columnAverage = result2d.reduce((acc, cur) => {
            cur.forEach((e, i) => acc[i] = acc[i] ? acc[i] + e : e);
            return acc;
        }, []).map(e => e / result2d.length);
        //find maximum index
        minimumAverage = columnAverage.reduce((m, n) => Math.min(m, n))
        coumnNumber = columnAverage.indexOf(minimumAverage)
        column = result2d.map(function (e) { return e[coumnNumber] })
        minScore = Math.min.apply(null, column)
        rownumber = column.indexOf(minScore)


        inverted = 100 - minimumAverage * 100 + 15 //15 is added threshold
        if (inverted >= 100) inverted = 99 //if max out due to added threshold set to 99
        document.getElementById('matchPercentage').innerHTML = Math.ceil(inverted) + "%"


        return [inverted, detectionResults[rownumber][coumnNumber]]

    }


    function FrameCollectionCompleted(bestResult) {

        document.getElementsByClassName("input_video")[0].pause()
        document.getElementById("RetakeButton").style.display = ''
        document.getElementById("SubmitButton").style.display = ''

        ImageURI = captureVideoFrame(document.getElementsByClassName("input_video")[0], "jpeg", 0.95).dataUri
        debugger
        output = {
            "AvgScore": bestResult[0],
            "LatestImageURI": ImageURI,
            "BestMatch": {
                id: bestResult[1].imageid,
                imageUrl: bestResult[1].imageUrl,
                rawScore: bestResult[1].distance
            }, "rawDetectionResults": detectionResults

        }
        console.log(output)
        return output
    }

    function retake() {
        document.getElementsByClassName("input_video")[0].play()
        detectionResults = null

    }



</script>